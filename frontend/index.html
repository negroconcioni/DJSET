<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AutoMix AI</title>
  <style>
    :root {
      --bg: #0d0d0f;
      --surface: #16161a;
      --border: #2a2a2e;
      --text: #e4e4e7;
      --muted: #71717a;
      --accent: #7c3aed;
      --accent-hover: #8b5cf6;
      --success: #22c55e;
      --error: #ef4444;
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem 1rem;
    }
    h1 {
      font-size: 1.75rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    .sub {
      color: var(--muted);
      font-size: 0.9rem;
      margin-bottom: 2rem;
    }
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      width: 100%;
      max-width: 420px;
      margin-bottom: 1rem;
    }
    .card h2 {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin: 0 0 0.75rem 0;
    }
    .row {
      display: flex;
      gap: 1rem;
      align-items: stretch;
      flex-wrap: wrap;
    }
    .row .card { flex: 1; min-width: 200px; }
    label {
      display: block;
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 0.35rem;
    }
    input[type="file"] {
      display: none;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.6rem 1rem;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: background 0.15s;
    }
    .btn-upload {
      background: var(--border);
      color: var(--text);
      width: 100%;
    }
    .btn-upload:hover { background: #3f3f46; }
    .btn-primary {
      background: var(--accent);
      color: white;
      width: 100%;
      margin-top: 0.5rem;
    }
    .btn-primary:hover { background: var(--accent-hover); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-download {
      background: var(--success);
      color: white;
      width: 100%;
      margin-top: 0.5rem;
    }
    .btn-download:hover { filter: brightness(1.1); }
    .file-name {
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: 0.35rem;
      min-height: 1.2em;
    }
    .status {
      font-size: 0.85rem;
      margin-top: 1rem;
      padding: 0.75rem;
      border-radius: 8px;
      background: rgba(124, 58, 237, 0.15);
      border: 1px solid rgba(124, 58, 237, 0.3);
    }
    .status.error { background: rgba(239, 68, 68, 0.15); border-color: rgba(239, 68, 68, 0.3); }
    .status pre { margin: 0; font-size: 0.75rem; overflow: auto; max-height: 120px; }
    #downloadBlock { display: none; }
  </style>
</head>
<body>
  <h1>AutoMix AI</h1>
  <p class="sub">Subí dos canciones. El sistema analiza BPM, key y energía; un LLM elige la transición y se genera la mezcla.</p>

  <div class="card">
    <h2>Paso 1 — Subir canciones</h2>
    <div class="row">
      <div class="card">
        <label>Song A (salida)</label>
        <button type="button" class="btn btn-upload" id="btnA">Elegir archivo A</button>
        <input type="file" id="fileA" accept="audio/*">
        <div class="file-name" id="nameA">—</div>
      </div>
      <div class="card">
        <label>Song B (entrada)</label>
        <button type="button" class="btn btn-upload" id="btnB">Elegir archivo B</button>
        <input type="file" id="fileB" accept="audio/*">
        <div class="file-name" id="nameB">—</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Paso 2 — Generar mezcla</h2>
    <button type="button" class="btn btn-primary" id="btnGenerate" disabled>Generar mezcla</button>
    <div class="status" id="status" style="display: none;"></div>
    <div id="downloadBlock">
      <a id="downloadLink" class="btn btn-download" href="#" download="automix_mix.wav">Descargar mezcla</a>
    </div>
  </div>

  <script>
    const API = window.location.origin;
    let sessionId = null;
    const fileA = document.getElementById('fileA');
    const fileB = document.getElementById('fileB');
    const nameA = document.getElementById('nameA');
    const nameB = document.getElementById('nameB');
    const btnGenerate = document.getElementById('btnGenerate');
    const status = document.getElementById('status');
    const downloadBlock = document.getElementById('downloadBlock');
    const downloadLink = document.getElementById('downloadLink');

    document.getElementById('btnA').addEventListener('click', () => fileA.click());
    document.getElementById('btnB').addEventListener('click', () => fileB.click());

    async function ensureSession() {
      if (sessionId) return sessionId;
      const r = await fetch(API + '/session', { method: 'POST' });
      const d = await r.json();
      sessionId = d.session_id;
      return sessionId;
    }

    fileA.addEventListener('change', async (e) => {
      const f = e.target.files[0];
      if (!f) return;
      nameA.textContent = f.name;
      try {
        await ensureSession();
        const fd = new FormData();
        fd.append('file', f);
        const r = await fetch(API + '/upload/' + sessionId + '/a', { method: 'POST', body: fd });
        if (!r.ok) throw new Error(await r.text());
      } catch (err) {
        nameA.textContent = 'Error';
        showStatus(err.message, true);
      }
      updateGenerateButton();
    });

    fileB.addEventListener('change', async (e) => {
      const f = e.target.files[0];
      if (!f) return;
      nameB.textContent = f.name;
      try {
        await ensureSession();
        const fd = new FormData();
        fd.append('file', f);
        const r = await fetch(API + '/upload/' + sessionId + '/b', { method: 'POST', body: fd });
        if (!r.ok) throw new Error(await r.text());
      } catch (err) {
        nameB.textContent = 'Error';
        showStatus(err.message, true);
      }
      updateGenerateButton();
    });

    function updateGenerateButton() {
      btnGenerate.disabled = !fileA.files[0] || !fileB.files[0];
    }

    function showStatus(msg, isError = false) {
      status.style.display = 'block';
      status.className = 'status' + (isError ? ' error' : '');
      status.innerHTML = msg;
    }

    btnGenerate.addEventListener('click', async () => {
      if (!sessionId) await ensureSession();
      btnGenerate.disabled = true;
      showStatus('Analizando y generando mezcla…');
      downloadBlock.style.display = 'none';
      try {
        const r = await fetch(API + '/generate/' + sessionId, { method: 'POST' });
        const d = await r.json().catch(() => ({}));
        if (!r.ok) {
        const msg = Array.isArray(d.detail) ? (d.detail[0]?.msg || JSON.stringify(d.detail)) : (d.detail || 'Error');
        throw new Error(typeof msg === 'string' ? msg : JSON.stringify(msg));
      }
        showStatus(
          'Listo. Análisis A: BPM ' + d.analysis_a?.bpm + ', key ' + d.analysis_a?.key + '. ' +
          'Análisis B: BPM ' + d.analysis_b?.bpm + ', key ' + d.analysis_b?.key + '. ' +
          'Estrategia: ' + (d.strategy?.reasoning || '—')
        );
        downloadLink.href = API + '/download/' + sessionId;
        downloadBlock.style.display = 'block';
      } catch (err) {
        showStatus(err.message, true);
      }
      btnGenerate.disabled = false;
    });
  </script>
</body>
</html>
